
----------EASY QUERY------------ 

_______SENSOR DATA_________
    SET search_path TO gman_a35, public;
    SELECT alias.value AS measurement, alias.date AS timestamp 
    FROM (SELECT sv.name_sens, sv.value, sv.date FROM sensor_vec AS sv, sensor AS s WHERE s.mote_id=1 AND sv.name_sens='TEMP1') AS alias 
    WHERE alias.date BETWEEN '2021-05-14 10:58:05' AND '2021-05-15 10:58:59'

_______ACTUATOR DATA_________

    SET search_path TO gman_a35, public;
    select t.name_act as Actuator, actuator.section_id as Cell, t.state as State
    from 
        (select name_act, max(date) as MaxDate
        from actuator_vec
        group by name_act) AS tm, actuator_vec AS t, actuator
    where t.date = tm.MaxDate and actuator.name = tm.name_act

_______CONFIGURATION DATA_________

    SET search_path TO gman_a35, public;
    UPDATE mote
    SET section_id = CASE 
                 WHEN mote.section_id<>t1.section_id THEN t1.section_id
                 WHEN mote.section_id=t1.section_id THEN mote.section_id-1
                 END
    FROM (SELECT section.section_id FROM section
      ORDER BY section.section_id DESC) AS t1
    RETURNING mote.mote_id AS Sensor,mote.section_id AS Cell
    
//////////////////// TESTES
    SET search_path TO gman_a35, public;
    UPDATE mote
    SET section_id=t1.section_id
    FROM(SELECT section.section_id FROM section
          ORDER BY section.section_id DESC) AS t1
    WHERE mote.section_id!=t1.section_id
    RETURNING mote.mote_id,mote.section_id
    
    SET search_path TO gman_a35, public;
    UPDATE mote
    SET section_id = CASE 
                 WHEN mote.section_id!=t1.section_id THEN t1.section_id
                 WHEN mote.section_id=t1.section_id THEN t1.section_id
                 END
    FROM (SELECT section.section_id FROM section
      ORDER BY section.section_id DESC) AS t1
    RETURNING mote.mote_id,mote.section_id
///////////////////


_______CONTROL RULE DATA_________

    SET search_path TO gman_a35, public;
    UPDATE subrule
    SET ref = 20
    from rule, actuator, op_r_subr
    where rule.name = actuator.name AND op_r_subr.subrule_id = subrule.subrule_id AND op_r_subr.rule_id = rule.rule_id AND rule.rule_id = 0
    returning rule.rule_id as Rule, actuator.section_id as Cell, subrule.ref as ReferenceValue, subrule.sensor_name


_______ENERGY DATA_________

SET search_path TO gman_a35,public;
SELECT timestamp, energy FROM (
SELECT timestamp, (Power*10^(-3)*5.555*10^(-7)) AS Energy, mote, name_act FROM

     (
     SELECT date AS timestamp, RIGHT(name_act,1) AS mote, name_act, state,
        CASE WHEN (state=TRUE) THEN (220*5)
        ELSE 0
        END AS Power
        FROM actuator_vec
     ) AS New
WHERE mote = '2'
     ORDER BY timestamp ASC) as New2
WHERE timestamp BETWEEN '2021-05-14 10:58:01' AND '2021-05-14 10:59:60';

----------MEDIUM QUERY------------ 


_______SENSOR DATA_________

    SET search_path TO gman_a35,public;
    SELECT CONCAT('SECTION',t1.section) AS ROOM, t1.average AS average
      FROM (SELECT sensor_vec.name_sens AS section, AVG(sensor_vec.value) AS average FROM sensor_vec
             GROUP BY sensor_vec.name_sens) AS t1, sensor
      WHERE sensor.name=t1.section AND SUBSTRING(sensor.name, 1, length(sensor.name)-1 ) = 'TEMP'
      

_______ACTUATOR DATA_________

    SET search_path TO gman_a35, public;
    select CONCAT('SECTION', actuator.section_id) AS room, count(name_act)-1 AS change
    from actuator_vec, actuator
    where actuator_vec.date between '2021-05-14 10:58:02.552664' AND '2021-05-15 10:58:31.724406' AND actuator_vec.name_act = actuator.name AND  
          ( SUBSTRING(actuator.name,1,length(actuator.name)-9) = 'HEAT' OR SUBSTRING(actuator.name,1,length(actuator.name)-9) = 'FORNO' )
    group by name_act, actuator.section_id
    ORDER BY actuator.section_id ASC
    

_______CONFIGURATION DATA_________

    SET search_path TO gman_a35, public;
    SELECT  CONCAT('SECTION',section.section_id) AS room, COUNT(t1.mote_id) AS MoteCount, t2.count AS SensorCount
    FROM section, 
         (SELECT mote.section_id, mote_id FROM mote GROUP BY mote.section_id,mote_id) AS t1 , 
         (SELECT COUNT(mote_id) AS count,mote_id FROM sensor GROUP BY sensor.mote_id,mote_id) AS t2
    WHERE t1.section_id=section.section_id AND t2.mote_id=t1.section_id
    GROUP BY section.section_id,t2.count
    

_______CONTROL RULE DATA_________

    SET search_path TO gman_a35, public;
    select CONCAT('SECTION',section.section_id) as room, count(tm.section_id) as Rules
    from (select rule.rule_id, rule.name, actuator.section_id from rule, actuator where rule.name = actuator.name) as tm, section
    where tm.section_id = section.section_id
    group by section.section_id, tm.section_id
    order by room ASC


_______ENERGY DATA_________

    SET search_path TO gman_a35,public;
    SELECT CONCAT('SECTION',mote) AS room, SUM (energy)*0.1544 AS cost FROM (
    SELECT timestamp, (Power*10^(-3)*5.555*10^(-7)) AS Energy, mote, name_act FROM

         (
         SELECT date AS timestamp, RIGHT(name_act,1) AS mote, name_act, state,
            CASE WHEN (state=TRUE) THEN (220*5)
            ELSE 0
            END AS Power
            FROM actuator_vec
         ) AS New
    WHERE timestamp BETWEEN '2021-05-14 10:57:05' AND '2021-05-14 10:59:59'
         ) as New2
    GROUP BY mote ORDER BY mote ASC;

